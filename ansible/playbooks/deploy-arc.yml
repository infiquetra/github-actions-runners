---
# Deploy ARC (Actions Runner Controller) to MicroK8s Cluster
#
# Usage:
#   ansible-playbook playbooks/deploy-arc.yml --vault-password-file ~/.vault_pass.txt
#
# Tags:
#   - controller: Deploy only the ARC controller
#   - runner-set: Deploy only the runner scale set
#   - namespaces: Create namespaces only
#   - secrets: Update GitHub App secret only
#   - storage: Create storage resources only
#   - helm: Run Helm deployments only
#   - verify: Run verification tasks only

- name: Deploy ARC to Kubernetes
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../group_vars/all/vars.yml

  pre_tasks:
    - name: Check for vault file
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../group_vars/all/vault.yml"
      register: vault_file

    - name: Load vault variables if present
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../group_vars/all/vault.yml"
      when: vault_file.stat.exists
      no_log: true

    - name: Verify kubectl is available
      ansible.builtin.command: kubectl version --client
      changed_when: false
      register: kubectl_check

    - name: Display kubectl version
      ansible.builtin.debug:
        msg: "kubectl is available"

    - name: Verify Helm is available
      ansible.builtin.command: helm version --short
      changed_when: false
      register: helm_check

    - name: Display Helm version
      ansible.builtin.debug:
        msg: "Helm is available"

  roles:
    - role: arc-controller
      tags:
        - controller
        - always-controller

    - role: arc-runner-set
      tags:
        - runner-set
        - always-runner-set

  post_tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg: |
          ============================================
          ARC Deployment Complete!
          ============================================

          Controller Namespace: {{ arc_controller.namespace }}
          Runners Namespace: {{ arc_runner_set.namespace }}

          Runner Scale Set: {{ arc_runner_set.runner_scale_set_name }}
          GitHub Org: {{ arc_runner_set.github_config_url }}

          To use in your workflows:
            runs-on: {{ arc_runner_set.runner_scale_set_name }}

          Useful commands:
            kubectl get pods -n {{ arc_controller.namespace }}
            kubectl get pods -n {{ arc_runner_set.namespace }}
            kubectl get hra -n {{ arc_runner_set.namespace }}

          ============================================
