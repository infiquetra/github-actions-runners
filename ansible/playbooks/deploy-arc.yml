---
# Deploy ARC (Actions Runner Controller) to MicroK8s Cluster
#
# This playbook SSHs to a designated cluster host (r420) and runs
# kubectl/helm commands there. The local machine doesn't need cluster access.
#
# Usage:
#   ansible-playbook playbooks/deploy-arc.yml --vault-password-file ~/.vault_pass.txt
#
# Tags:
#   - controller: Deploy only the ARC controller
#   - runner-set: Deploy only the runner scale set
#   - namespaces: Create namespaces only
#   - secrets: Update GitHub App secret only
#   - storage: Create storage resources only
#   - helm: Run Helm deployments only
#   - verify: Run verification tasks only

- name: Deploy ARC to Kubernetes
  hosts: cluster
  gather_facts: yes
  become: yes

  vars_files:
    - ../group_vars/all/vars.yml
    - ../group_vars/all/vault.yml

  roles:
    - role: arc-controller
      tags:
        - controller
        - always-controller

    - role: arc-runner-set
      tags:
        - runner-set
        - always-runner-set

  post_tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg: |
          ============================================
          ARC Deployment Complete!
          ============================================

          Controller Namespace: {{ arc_controller.namespace }}
          Runners Namespace: {{ arc_runner_set.namespace }}

          Runner Scale Set: {{ arc_runner_set.runner_scale_set_name }}
          GitHub Org: {{ arc_runner_set.github_config_url }}

          To use in your workflows:
            runs-on: {{ arc_runner_set.runner_scale_set_name }}

          Useful commands:
            kubectl get pods -n {{ arc_controller.namespace }}
            kubectl get pods -n {{ arc_runner_set.namespace }}
            kubectl get hra -n {{ arc_runner_set.namespace }}

          ============================================
      when: inventory_hostname == designated_host
